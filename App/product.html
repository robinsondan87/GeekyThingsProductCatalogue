<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product Details - GeekyThings</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <style>
      :root {
        --ink: #1b1b1f;
        --muted: #4b4e57;
        --surface: #ffffff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        color: var(--ink);
        background: #f2f2f2;
        min-height: 100vh;
      }

      header {
        padding: 24px clamp(20px, 4vw, 64px) 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 12px;
      }

      .nav {
        width: 100%;
        max-width: 1100px;
        margin: 0 auto 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      .nav-brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-links {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .nav-links a {
        text-decoration: none;
        font-weight: 600;
        color: #0a663b;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid #cfe6dc;
        background: #ffffff;
      }

      .nav-links a:hover {
        background: #e0f2f1;
        color: #00796b;
      }

      h1 {
        margin: 0;
        color: #0a663b;
        font-size: clamp(22px, 3vw, 32px);
      }

      .version {
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .version a {
        color: inherit;
        text-decoration: none;
      }

      .version a:hover {
        text-decoration: underline;
      }

      main {
        padding: 24px clamp(20px, 4vw, 64px) 48px;
        display: grid;
        gap: 20px;
      }

      .card {
        background: var(--surface);
        border-radius: 18px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.10), 0 1.5px 4px rgba(0,0,0,0.08);
        padding: 20px;
      }

      .grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      label {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 6px;
        display: block;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #d2d2d8;
        font-family: inherit;
        font-size: 14px;
      }

      textarea {
        min-height: 240px;
      }

      .listing-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
      }

      .listing-option {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        background: #f7faf9;
        border: 1px solid #cfe6dc;
        padding: 6px 8px;
        border-radius: 8px;
        opacity: 0.7;
      }

      .listing-option input {
        margin: 0;
      }

      .listing-links {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .listing-links a {
        text-decoration: none;
        color: #0a663b;
        border: 1px solid #cfe6dc;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        background: #ffffff;
        font-weight: 600;
      }

      .ukca-status {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .ukca-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
        letter-spacing: 0.02em;
        border: 1px solid transparent;
      }

      .ukca-badge.is-yes {
        background: #e0f2f1;
        color: #0a663b;
        border-color: #cfe6dc;
      }

      .ukca-badge.is-no {
        background: #fff3e0;
        color: #8a4b00;
        border-color: #ffd7b0;
      }

      .ukca-badge.is-na {
        background: #f0f4f8;
        color: #54606c;
        border-color: #d6dde5;
      }

      .url-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        margin-top: 12px;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-end;
      }

      .btn {
        background: #0a663b;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn.secondary {
        background: #00796b;
      }

      .btn.ghost {
        background: #ffffff;
        color: #0a663b;
        border: 1px solid #cfe6dc;
      }

      .status {
        font-size: 13px;
        color: var(--muted);
      }

      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
      }

      .media-item {
        display: grid;
        gap: 8px;
        position: relative;
      }

      .media-grid img,
      .media-grid video {
        width: 100%;
        border-radius: 12px;
        border: 1px solid #e2e6e8;
        background: #fff;
      }

      .media-actions {
        position: absolute;
        top: 6px;
        left: 6px;
        display: flex;
        justify-content: flex-start;
      }

      .media-actions .btn {
        padding: 2px 6px;
        font-size: 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.9);
      }

      .file-list {
        display: grid;
        gap: 10px;
      }

      .file-item {
        display: grid;
        gap: 10px;
        grid-template-columns: minmax(0, 1fr);
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #e2e6e8;
        background: #fff;
      }

      .file-name {
        font-weight: 600;
      }

      .file-path {
        font-size: 12px;
        color: var(--muted);
        word-break: break-all;
      }

      .file-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .file-actions .btn {
        padding: 6px 10px;
        font-size: 12px;
      }

      .ukca-pack {
        border: 1px solid #e2e6e8;
        border-radius: 12px;
        padding: 10px 14px;
        background: #ffffff;
      }

      .ukca-pack summary {
        font-weight: 700;
        color: #0a663b;
        cursor: pointer;
      }

      .ukca-pack-body {
        margin-top: 12px;
      }

      .ukca-pack-empty {
        color: var(--muted);
        font-size: 13px;
      }

      .ukca-pack-file {
        margin-top: 10px;
        border: 1px solid #e2e6e8;
        border-radius: 10px;
        padding: 8px 12px;
        background: #ffffff;
      }

      .ukca-pack-file summary {
        font-weight: 600;
        color: #0a663b;
        cursor: pointer;
      }

      .ukca-pack-file textarea {
        width: 100%;
        min-height: 180px;
        margin-top: 10px;
      }

      .ukca-en71-form {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }

      .ukca-en71-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .ukca-pack-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-bottom: 12px;
      }

      .upload-zone {
        border: 2px dashed #cfe6dc;
        border-radius: 14px;
        padding: 20px;
        text-align: center;
        color: var(--muted);
        background: #f7faf9;
        cursor: pointer;
      }

      .upload-zone.dragover {
        border-color: #0a663b;
        color: #0a663b;
        background: #e0f2f1;
      }

      .upload-zone strong {
        color: #0a663b;
      }

      dialog {
        border: none;
        border-radius: 16px;
        padding: 0;
        max-width: 520px;
        width: min(92vw, 520px);
        box-shadow: 0 24px 80px rgba(15, 23, 42, 0.25);
      }

      dialog::backdrop {
        background: rgba(15, 23, 42, 0.55);
      }

      .dialog-header {
        padding: 18px 22px;
        border-bottom: 1px solid #e2e6e8;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .dialog-body {
        padding: 18px 22px;
        display: grid;
        gap: 12px;
      }

      .dialog-actions {
        padding: 16px 22px;
        border-top: 1px solid #e2e6e8;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      @media (min-width: 720px) {
        .file-item {
          grid-template-columns: minmax(0, 1fr) auto;
          align-items: center;
        }
      }

    </style>
  </head>
  <body>
    <header>
      <nav class="nav">
        <div class="nav-brand">
          <strong>GeekyThings</strong>
        </div>
        <div class="nav-links">
          <a href="/">Products</a>
          <a href="/add.html">Add Product</a>
        </div>
      </nav>
      <h1 id="productTitle">Product Details</h1>
      <div class="version">
        Version <a href="https://github.com/robinsondan87/GeekyThingsProductCatalogue/blob/main/CHANGELOG.md" target="_blank" rel="noopener noreferrer">v1.6.0</a>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="grid">
          <div>
            <label for="category">Category</label>
            <input id="category" type="text" disabled />
          </div>
          <div>
            <label for="sku">SKU</label>
            <input id="sku" type="text" />
          </div>
          <div>
            <label>UKCA status</label>
            <div class="ukca-status">
              <span class="ukca-badge is-no" id="ukcaStatus">No</span>
              <button class="btn ghost" id="ukcaAddBtn" type="button">Add UKCA Pack</button>
            </div>
          </div>
        </div>
        <div class="grid" style="margin-top: 12px;">
          <div>
            <label for="productFolder">Product folder</label>
            <input id="productFolder" type="text" />
          </div>
          <div>
            <label for="tags">Tags</label>
            <input id="tags" type="text" placeholder="comma,separated,tags" />
          </div>
        </div>
        <div style="margin-top: 12px;">
          <label>Listings (auto from URLs)</label>
          <div class="listing-group" id="listingGroup"></div>
          <div class="listing-links" id="listingLinks"></div>
        </div>
        <div class="url-grid">
          <div>
            <label for="facebookUrl">Facebook URL</label>
            <input id="facebookUrl" type="url" placeholder="https://..." />
          </div>
          <div>
            <label for="tiktokUrl">TikTok URL</label>
            <input id="tiktokUrl" type="url" placeholder="https://..." />
          </div>
          <div>
            <label for="ebayUrl">Ebay URL</label>
            <input id="ebayUrl" type="url" placeholder="https://..." />
          </div>
          <div>
            <label for="etsyUrl">Etsy URL</label>
            <input id="etsyUrl" type="url" placeholder="https://..." />
          </div>
        </div>
        <div class="actions" style="margin-top: 16px;">
          <button class="btn ghost" id="openFolderBtn" type="button">Open Folder</button>
          <button class="btn ghost" id="renameBtn" type="button">Rename Folder</button>
          <button class="btn secondary" id="saveDetailsBtn" type="button">Save Details</button>
        </div>
        <div class="status" id="status"></div>
      </section>

      <section class="card">
        <label for="readme">README.md</label>
        <textarea id="readme"></textarea>
        <div class="actions" style="margin-top: 12px;">
          <button class="btn" id="saveReadmeBtn" type="button">Save README</button>
        </div>
      </section>

      <section class="card">
        <h2 style="margin-top:0;color:#0a663b;">Media</h2>
        <div class="media-grid" id="mediaGrid"></div>
      </section>

      <section class="card">
        <h2 style="margin-top:0;color:#0a663b;">3MF Files</h2>
        <div class="file-list" id="threeMfList"></div>
      </section>

      <section class="card" id="ukcaPackSection" hidden>
        <details class="ukca-pack" id="ukcaPackDetails">
          <summary>UKCA Pack</summary>
          <div class="ukca-pack-body">
            <div class="ukca-pack-actions">
              <button class="btn ghost" id="printUkcaBtn" type="button">Print UKCA Pack</button>
            </div>
            <div class="file-list" id="ukcaPackList"></div>
          </div>
        </details>
      </section>

      <section class="card">
        <h2 style="margin-top:0;color:#0a663b;">Upload Media / 3MF</h2>
        <div class="upload-zone" id="uploadZone">
          <strong>Drop files here</strong> or click to choose
        </div>
        <input id="uploadInput" type="file" multiple hidden />
      </section>
    </main>

    <dialog id="ukcaDialog">
      <form id="ukcaForm">
        <div class="dialog-header">
          <strong>Create UKCA Pack</strong>
        </div>
        <div class="dialog-body">
          <div>
            <label for="ukcaProductName">Product name</label>
            <input id="ukcaProductName" type="text" required />
          </div>
          <div>
            <label for="ukcaSku">SKU</label>
            <input id="ukcaSku" type="text" />
          </div>
          <div>
            <label for="ukcaMaterials">Materials</label>
            <input id="ukcaMaterials" type="text" placeholder="PLA / PETG" />
          </div>
          <div>
            <label for="ukcaIntendedAge">Intended age</label>
            <input id="ukcaIntendedAge" type="text" placeholder="3+" />
          </div>
          <div>
            <label for="ukcaManufacturer">Manufacturer</label>
            <input id="ukcaManufacturer" type="text" placeholder="GeekyThingsUK" />
          </div>
          <div>
            <label for="ukcaAddress">Manufacturer address</label>
            <input id="ukcaAddress" type="text" placeholder="United Kingdom" />
          </div>
          <div>
            <label for="ukcaTester">Tester</label>
            <input id="ukcaTester" type="text" placeholder="Dan Robinson" />
          </div>
          <div>
            <label for="ukcaTestDate">Test date</label>
            <input id="ukcaTestDate" type="date" />
          </div>
          <div>
            <label for="ukcaNotes">Notes</label>
            <textarea id="ukcaNotes" rows="3" placeholder="Optional notes..."></textarea>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn ghost" type="button" onclick="document.getElementById('ukcaDialog').close()">Cancel</button>
          <button class="btn" type="submit">Create UKCA Pack</button>
        </div>
      </form>
    </dialog>

    <script>
      const params = new URLSearchParams(window.location.search);
      const categoryParam = params.get("category") || "";
      const folderParam = params.get("folder") || "";
      const statusParam = (params.get("status") || "").toLowerCase();

      const productTitle = document.getElementById("productTitle");
      const categoryInput = document.getElementById("category");
      const skuInput = document.getElementById("sku");
      const ukcaStatus = document.getElementById("ukcaStatus");
      const ukcaAddBtn = document.getElementById("ukcaAddBtn");
      const productFolderInput = document.getElementById("productFolder");
      const tagsInput = document.getElementById("tags");
      const listingGroup = document.getElementById("listingGroup");
      const listingLinks = document.getElementById("listingLinks");
      const facebookUrlInput = document.getElementById("facebookUrl");
      const tiktokUrlInput = document.getElementById("tiktokUrl");
      const ebayUrlInput = document.getElementById("ebayUrl");
      const etsyUrlInput = document.getElementById("etsyUrl");
      const saveDetailsBtn = document.getElementById("saveDetailsBtn");
      const renameBtn = document.getElementById("renameBtn");
      const openFolderBtn = document.getElementById("openFolderBtn");
      const statusEl = document.getElementById("status");
      const readmeArea = document.getElementById("readme");
      const saveReadmeBtn = document.getElementById("saveReadmeBtn");
      const mediaGrid = document.getElementById("mediaGrid");
      const threeMfList = document.getElementById("threeMfList");
      const uploadZone = document.getElementById("uploadZone");
      const uploadInput = document.getElementById("uploadInput");
      const ukcaDialog = document.getElementById("ukcaDialog");
      const ukcaForm = document.getElementById("ukcaForm");
      const ukcaProductName = document.getElementById("ukcaProductName");
      const ukcaSku = document.getElementById("ukcaSku");
      const ukcaMaterials = document.getElementById("ukcaMaterials");
      const ukcaIntendedAge = document.getElementById("ukcaIntendedAge");
      const ukcaManufacturer = document.getElementById("ukcaManufacturer");
      const ukcaAddress = document.getElementById("ukcaAddress");
      const ukcaTester = document.getElementById("ukcaTester");
      const ukcaTestDate = document.getElementById("ukcaTestDate");
      const ukcaNotes = document.getElementById("ukcaNotes");
      const ukcaPackSection = document.getElementById("ukcaPackSection");
      const ukcaPackDetails = document.getElementById("ukcaPackDetails");
      const ukcaPackList = document.getElementById("ukcaPackList");
      const printUkcaBtn = document.getElementById("printUkcaBtn");

      const listingOptions = ["Facebook", "TikTok", "Ebay", "Etsy"];
      const baseCategoriesPath = "/Users/dan/GeekyThings/Products/Categories";
      const draftBasePath = "/Users/dan/GeekyThings/Products/Categories/_Draft";

      let headers = [];
      let rows = [];
      let rowIndex = -1;
      let originalCategory = categoryParam;
      let originalFolder = folderParam;
      let currentUkcaStatus = "No";
      let ukcaPackFiles = [];

      const ukcaFileLabels = {
        readme: "UKCA README",
        declaration: "Declaration of Conformity",
        risk_assessment: "Risk Assessment",
        en71: "EN71-1 Compliance Pack",
      };

      const defaultEn71Data = () => ({
        productName: productFolderInput.value || "",
        sku: skuInput.value || "",
        material: "PLA / PETG",
        intendedAge: "3+",
        tester: "Dan Robinson",
        testDate: "",
        dropResult: "PASS",
        tensionResult: "PASS",
        torsionResult: "PASS",
        smallParts: "No",
        warningLabel: "Yes",
        finalResult: "PASS",
        visualNotes: "Visual inspection completed. No sharp edges, burrs, or defects observed. Surface finish smooth.",
        dropNotes: "Drop testing completed. No hazardous breakage observed; any minor separation was blunt with no sharp edges.",
        tensionNotes: "Tension test completed. No hazardous detachment observed; joints remained secure under manual force.",
        torsionNotes: "Torsion test completed. No hazardous fracture observed; no sharp edges created.",
        smallPartsNotes: "Small parts not created. Warning label remains applicable for 3+ age grading.",
        conclusionNotes: "Product either withstood testing or fractured in a non-hazardous manner. No sharp edges or points created.",
      });

      const generateEn71Markdown = (data) => {
        return `# EN71-1 Compliance Pack - ${data.productName} (SKU: ${data.sku})\n\n` +
          `Material: ${data.material}\n` +
          `Intended Age: ${data.intendedAge}\n` +
          `Date Tested: ${data.testDate || "______________________________"}\n` +
          `Tester: ${data.tester}\n\n` +
          `---\n\n` +
          `## 1) EN71-1 Self-Test Checklist (3+ Toys)\n\n` +
          `### A. Visual & Construction Checks\n` +
          `Result: ${data.visualNotes ? "SEE NOTES" : "PASS"}\n\n` +
          `Notes: ${data.visualNotes || "No sharp edges, burrs, or defects observed."}\n\n` +
          `### B. Drop / Impact Test\n` +
          `Method: Drop from 1.0 m onto hard surface - 3 times\n\n` +
          `Result: ${data.dropResult}\n\n` +
          `Notes: ${data.dropNotes || "No hazardous breakage observed."}\n\n` +
          `### C. Tension / Pull Test\n` +
          `Result: ${data.tensionResult}\n\n` +
          `Notes: ${data.tensionNotes || "No hazardous detachment observed."}\n\n` +
          `### D. Torsion / Twist Test\n` +
          `Result: ${data.torsionResult}\n\n` +
          `Notes: ${data.torsionNotes || "No hazardous fracture observed."}\n\n` +
          `### E. Small Parts (Post-Breakage)\n` +
          `Small parts created: ${data.smallParts}\n\n` +
          `Warning label applied: ${data.warningLabel}\n\n` +
          `Notes: ${data.smallPartsNotes || "Not suitable for under 36 months. Small parts."}\n\n` +
          `### F. Overall Mechanical Safety Conclusion\n` +
          `Final Result: ${data.finalResult}\n\n` +
          `Notes: ${data.conclusionNotes || "Product either withstood testing or fractured in a non-hazardous manner."}\n\n` +
          `Signature: ${data.tester}\n` +
          `Date: ${data.testDate || "______________________________"}\n\n` +
          `---\n\n` +
          `## 2) Packaging Warning Labels & Age Grading (UKCA / EN71-1)\n\n` +
          `**Mandatory Age Warning (Plain):**\n` +
          `Not suitable for children under 36 months. Small parts.\n\n` +
          `**Recommended Notes:**\n` +
          `- Sensory fidget toy.\n` +
          `- Not a teething toy.\n` +
          `- Adult supervision recommended.\n` +
          `- Inspect regularly and discard if damaged.\n\n` +
          `**Manufacturer / Responsible Person:**\n` +
          `GeekyThingsUK\n` +
          `United Kingdom\n` +
          `www.geekythings.co.uk\n\n` +
          `---\n\n` +
          `## 3) EN71-1 Compliance Section for UKCA Technical File\n\n` +
          `Product Name: ${data.productName}\n` +
          `SKU(s): ${data.sku}\n` +
          `Material: ${data.material}\n` +
          `Intended Age Group: ${data.intendedAge}\n\n` +
          `The product is a 3D-printed articulated sensory fidget toy manufactured from PLA or PETG. ` +
          `It contains no electronics, no magnets, and no metal components.\n\n` +
          `Applicable Standard: EN 71-1:2014 + A1:2018\n\n` +
          `Based on the testing above, the product is considered to comply with the mechanical and physical ` +
          `safety requirements of EN 71-1 for toys intended for children aged 3 years and over.\n`;
      };

      const updateUkcaDisplay = () => {
        const statusValue = currentUkcaStatus || "No";
        ukcaStatus.textContent = statusValue;
        ukcaStatus.className = "ukca-badge";
        if (statusValue === "Yes") {
          ukcaStatus.classList.add("is-yes");
        } else if (statusValue === "N/A") {
          ukcaStatus.classList.add("is-na");
        } else {
          ukcaStatus.classList.add("is-no");
        }
        if (statusValue === "Yes") {
          ukcaAddBtn.textContent = "View/Edit UKCA Pack";
          ukcaPackSection.hidden = false;
        } else {
          ukcaAddBtn.textContent = "Add UKCA Pack";
          ukcaPackSection.hidden = true;
        }
      };

      const openUkcaSection = async (openEn71 = false) => {
        ukcaPackDetails.open = true;
        await loadUkcaPackList();
        if (openEn71) {
          const en71Detail = ukcaPackList.querySelector('details[data-file-key="en71"]');
          if (en71Detail) {
            en71Detail.open = true;
          }
        }
        ukcaPackSection.scrollIntoView({ behavior: "smooth", block: "start" });
      };

      const loadData = async () => {
        const response = await fetch("/api/rows", { cache: "no-store" });
        if (!response.ok) return;
        const data = await response.json();
        headers = data.headers || [];
        rows = data.rows || [];
        rowIndex = rows.findIndex(
          (row) => row.category === categoryParam && row.product_folder === folderParam
        );
        if (rowIndex === -1) {
          statusEl.textContent = "Product not found.";
          return;
        }
        const row = rows[rowIndex];
        productTitle.textContent = row.product_folder || "Product Details";
        categoryInput.value = row.category || "";
        skuInput.value = row.sku || "";
        currentUkcaStatus = row.UKCA || "No";
        updateUkcaDisplay();
        productFolderInput.value = row.product_folder || "";
        tagsInput.value = row.tags || "";
        facebookUrlInput.value = row["Facebook URL"] || "";
        tiktokUrlInput.value = row["TikTok URL"] || "";
        ebayUrlInput.value = row["Ebay URL"] || "";
        etsyUrlInput.value = row["Etsy URL"] || "";

        listingGroup.innerHTML = "";
        const updateListingLinks = () => {
          listingLinks.innerHTML = "";
          const urlMap = {
            Facebook: facebookUrlInput.value.trim(),
            TikTok: tiktokUrlInput.value.trim(),
            Ebay: ebayUrlInput.value.trim(),
            Etsy: etsyUrlInput.value.trim(),
          };
          listingGroup.querySelectorAll("input[type=checkbox]").forEach((checkbox) => {
            const platform = checkbox.dataset.platform;
            checkbox.checked = Boolean(urlMap[platform]);
          });
          Object.entries(urlMap).forEach(([platform, url]) => {
            if (!url) return;
            const link = document.createElement("a");
            link.href = url;
            link.target = "_blank";
            link.rel = "noopener noreferrer";
            link.textContent = platform;
            listingLinks.appendChild(link);
          });
        };
        listingOptions.forEach((option) => {
          const label = document.createElement("label");
          label.className = "listing-option";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.disabled = true;
          checkbox.dataset.platform = option;
          const text = document.createElement("span");
          text.textContent = option;
          label.appendChild(checkbox);
          label.appendChild(text);
          listingGroup.appendChild(label);
        });
        updateListingLinks();
        [facebookUrlInput, tiktokUrlInput, ebayUrlInput, etsyUrlInput].forEach((input) => {
          input.addEventListener("input", updateListingLinks);
        });

        await loadReadme();
        await loadMedia();
        await load3mf();
        await loadUkcaPackList();
      };

      const loadReadme = async () => {
        const response = await fetch("/api/readme", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: categoryParam,
            folder_name: productFolderInput.value,
            status: statusParam,
            action: "read",
          }),
        });
        const payload = await response.json();
        if (!response.ok) return;
        readmeArea.value = payload.content || "";
      };

      const loadMedia = async () => {
        const response = await fetch(
          `/api/media?category=${encodeURIComponent(categoryParam)}&folder=${encodeURIComponent(productFolderInput.value)}&status=${encodeURIComponent(statusParam)}`
        );
        if (!response.ok) return;
        const payload = await response.json();
        const files = payload.files || [];
        mediaGrid.innerHTML = "";
        files.forEach((file) => {
          const ext = file.name.split(".").pop().toLowerCase();
          const wrapper = document.createElement("div");
          wrapper.className = "media-item";
          if (["mp4", "mov", "webm", "m4v"].includes(ext)) {
            const video = document.createElement("video");
            video.src = file.url;
            video.controls = true;
            wrapper.appendChild(video);
          } else {
            const img = document.createElement("img");
            img.src = file.url;
            img.alt = file.name;
            wrapper.appendChild(img);
          }
          const actions = document.createElement("div");
          actions.className = "media-actions";
          const removeBtn = document.createElement("button");
          removeBtn.className = "btn ghost";
          removeBtn.type = "button";
          removeBtn.textContent = "X";
          removeBtn.title = "Remove";
          removeBtn.addEventListener("click", () => {
            if (!confirm("Move this file to _Deleted?")) return;
            deleteFile(file.rel_path).catch(console.error);
          });
          actions.appendChild(removeBtn);
          wrapper.appendChild(actions);
          mediaGrid.appendChild(wrapper);
        });
      };

      const load3mf = async () => {
        const response = await fetch(
          `/api/3mf?category=${encodeURIComponent(categoryParam)}&folder=${encodeURIComponent(productFolderInput.value)}&status=${encodeURIComponent(statusParam)}`
        );
        if (!response.ok) return;
        const payload = await response.json();
        const files = payload.files || [];
        threeMfList.innerHTML = "";
        if (!files.length) {
          threeMfList.textContent = "No .3mf files found.";
          return;
        }
        files.forEach((file) => {
          const row = document.createElement("div");
          row.className = "file-item";

          const info = document.createElement("div");
          const name = document.createElement("div");
          name.className = "file-name";
          name.textContent = file.name;
          const path = document.createElement("div");
          path.className = "file-path";
          path.textContent = file.rel_path || "";
          info.appendChild(name);
          info.appendChild(path);

          const actions = document.createElement("div");
          actions.className = "file-actions";
          const openLink = document.createElement("a");
          openLink.className = "btn ghost";
          openLink.textContent = "Open";
          const fileUrl = file.url ? `${window.location.origin}${file.url}` : "";
          openLink.href = fileUrl ? `bambustudioopen://${encodeURIComponent(fileUrl)}` : "#";
          openLink.target = "_blank";
          openLink.rel = "noopener noreferrer";

          const downloadLink = document.createElement("a");
          downloadLink.className = "btn ghost";
          downloadLink.textContent = "Download";
          downloadLink.href = file.url || "#";
          downloadLink.target = "_blank";
          downloadLink.rel = "noopener noreferrer";

          const copyBtn = document.createElement("button");
          copyBtn.className = "btn ghost";
          copyBtn.type = "button";
          copyBtn.textContent = "Copy Path";
          copyBtn.addEventListener("click", () => {
            const text = file.abs_path || file.url || "";
            if (!text) return;
            navigator.clipboard?.writeText(text).catch(() => {});
          });
          const removeBtn = document.createElement("button");
          removeBtn.className = "btn ghost";
          removeBtn.type = "button";
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", () => {
            if (!confirm("Move this file to _Deleted?")) return;
            deleteFile(file.rel_path).catch(console.error);
          });

          actions.appendChild(openLink);
          actions.appendChild(downloadLink);
          actions.appendChild(copyBtn);
          actions.appendChild(removeBtn);

          row.appendChild(info);
          row.appendChild(actions);
          threeMfList.appendChild(row);
        });
      };

      const loadUkcaPackList = async () => {
        if (currentUkcaStatus !== "Yes") {
          ukcaPackList.innerHTML = '<div class="ukca-pack-empty">No UKCA pack yet.</div>';
          return;
        }
        const response = await fetch(
          `/api/ukca_pack?category=${encodeURIComponent(categoryParam)}&folder=${encodeURIComponent(productFolderInput.value)}&status=${encodeURIComponent(statusParam)}`
        );
        if (!response.ok) return;
        const payload = await response.json();
        const files = payload.files || [];
        ukcaPackFiles = files.filter((file) => file.exists);
        ukcaPackList.innerHTML = "";
        if (!ukcaPackFiles.length) {
          ukcaPackList.innerHTML = '<div class="ukca-pack-empty">UKCA files not found.</div>';
          return;
        }
        ukcaPackFiles.forEach((file) => {
          const details = document.createElement("details");
          details.className = "ukca-pack-file";
          details.dataset.fileKey = file.key;
          const summary = document.createElement("summary");
          summary.textContent = ukcaFileLabels[file.key] || file.key;
          const textarea = document.createElement("textarea");
          textarea.placeholder = "Loading...";
          const actions = document.createElement("div");
          actions.className = "actions";
          actions.style.marginTop = "10px";
          const saveBtn = document.createElement("button");
          saveBtn.className = "btn secondary";
          saveBtn.type = "button";
          saveBtn.textContent = "Save UKCA File";
          saveBtn.addEventListener("click", () => {
            saveUkcaFile(file.key, textarea.value).catch(console.error);
          });
          actions.appendChild(saveBtn);

          if (file.key === "en71") {
            const form = document.createElement("div");
            form.className = "ukca-en71-form";
            const grid = document.createElement("div");
            grid.className = "ukca-en71-grid";
            const data = defaultEn71Data();
            const productInput = document.createElement("input");
            productInput.value = data.productName;
            const skuField = document.createElement("input");
            skuField.value = data.sku;
            const materialField = document.createElement("input");
            materialField.value = data.material;
            const ageField = document.createElement("input");
            ageField.value = data.intendedAge;
            const testerField = document.createElement("input");
            testerField.value = data.tester;
            const dateField = document.createElement("input");
            dateField.type = "date";
            const dropResult = document.createElement("select");
            ["PASS", "FAIL"].forEach((value) => {
              const option = document.createElement("option");
              option.value = value;
              option.textContent = value;
              dropResult.appendChild(option);
            });
            const tensionResult = document.createElement("select");
            ["PASS", "FAIL"].forEach((value) => {
              const option = document.createElement("option");
              option.value = value;
              option.textContent = value;
              tensionResult.appendChild(option);
            });
            const torsionResult = document.createElement("select");
            ["PASS", "FAIL"].forEach((value) => {
              const option = document.createElement("option");
              option.value = value;
              option.textContent = value;
              torsionResult.appendChild(option);
            });
            const smallParts = document.createElement("select");
            ["No", "Yes"].forEach((value) => {
              const option = document.createElement("option");
              option.value = value;
              option.textContent = value;
              smallParts.appendChild(option);
            });
            const warningLabel = document.createElement("select");
            ["Yes", "No"].forEach((value) => {
              const option = document.createElement("option");
              option.value = value;
              option.textContent = value;
              warningLabel.appendChild(option);
            });
            const finalResult = document.createElement("select");
            ["PASS", "FAIL"].forEach((value) => {
              const option = document.createElement("option");
              option.value = value;
              option.textContent = value;
              finalResult.appendChild(option);
            });

            const field = (label, input) => {
              const wrapper = document.createElement("div");
              const title = document.createElement("label");
              title.textContent = label;
              wrapper.appendChild(title);
              wrapper.appendChild(input);
              return wrapper;
            };

            grid.appendChild(field("Product name", productInput));
            grid.appendChild(field("SKU", skuField));
            grid.appendChild(field("Material", materialField));
            grid.appendChild(field("Intended age", ageField));
            grid.appendChild(field("Tester", testerField));
            grid.appendChild(field("Test date", dateField));
            grid.appendChild(field("Drop test", dropResult));
            grid.appendChild(field("Tension test", tensionResult));
            grid.appendChild(field("Torsion test", torsionResult));
            grid.appendChild(field("Small parts created", smallParts));
            grid.appendChild(field("Warning label applied", warningLabel));
            grid.appendChild(field("Final result", finalResult));
            form.appendChild(grid);

            const notesLabel = (labelText) => {
              const wrapper = document.createElement("div");
              const label = document.createElement("label");
              label.textContent = labelText;
              const area = document.createElement("textarea");
              area.rows = 2;
              wrapper.appendChild(label);
              wrapper.appendChild(area);
              return { wrapper, area };
            };

            const visualNotes = notesLabel("Visual checks notes");
            const dropNotes = notesLabel("Drop test notes");
            const tensionNotes = notesLabel("Tension test notes");
            const torsionNotes = notesLabel("Torsion test notes");
            const smallPartsNotes = notesLabel("Small parts notes");
            const conclusionNotes = notesLabel("Conclusion notes");
            visualNotes.area.value = data.visualNotes;
            dropNotes.area.value = data.dropNotes;
            tensionNotes.area.value = data.tensionNotes;
            torsionNotes.area.value = data.torsionNotes;
            smallPartsNotes.area.value = data.smallPartsNotes;
            conclusionNotes.area.value = data.conclusionNotes;
            form.appendChild(visualNotes.wrapper);
            form.appendChild(dropNotes.wrapper);
            form.appendChild(tensionNotes.wrapper);
            form.appendChild(torsionNotes.wrapper);
            form.appendChild(smallPartsNotes.wrapper);
            form.appendChild(conclusionNotes.wrapper);

            const generateBtn = document.createElement("button");
            generateBtn.className = "btn ghost";
            generateBtn.type = "button";
            generateBtn.textContent = "Generate EN71-1 Content";
            generateBtn.addEventListener("click", () => {
              const payload = {
                productName: productInput.value.trim(),
                sku: skuField.value.trim(),
                material: materialField.value.trim(),
                intendedAge: ageField.value.trim(),
                tester: testerField.value.trim(),
                testDate: dateField.value,
                dropResult: dropResult.value,
                tensionResult: tensionResult.value,
                torsionResult: torsionResult.value,
                smallParts: smallParts.value,
                warningLabel: warningLabel.value,
                finalResult: finalResult.value,
                visualNotes: visualNotes.area.value.trim(),
                dropNotes: dropNotes.area.value.trim(),
                tensionNotes: tensionNotes.area.value.trim(),
                torsionNotes: torsionNotes.area.value.trim(),
                smallPartsNotes: smallPartsNotes.area.value.trim(),
                conclusionNotes: conclusionNotes.area.value.trim(),
              };
              textarea.value = generateEn71Markdown(payload);
            });
            form.appendChild(generateBtn);
            details.appendChild(summary);
            details.appendChild(form);
            details.appendChild(textarea);
            details.appendChild(actions);
          } else {
            details.appendChild(summary);
            details.appendChild(textarea);
            details.appendChild(actions);
          }
          details.appendChild(summary);
          details.appendChild(textarea);
          details.appendChild(actions);
          details.addEventListener("toggle", () => {
            if (!details.open || details.dataset.loaded === "true") return;
            loadUkcaFile(file.key, textarea)
              .then(() => {
                details.dataset.loaded = "true";
              })
              .catch(console.error);
          });
          ukcaPackList.appendChild(details);
        });
      };

      const loadUkcaFile = async (fileKey, textarea) => {
        const response = await fetch("/api/ukca_pack", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: categoryParam,
            folder_name: productFolderInput.value,
            status: statusParam,
            action: "read",
            file: fileKey,
          }),
        });
        const payload = await response.json();
        if (!response.ok) {
          statusEl.textContent = payload.error || "Failed to load UKCA file.";
          return;
        }
        textarea.value = payload.content || "";
      };

      const saveDetails = async () => {
        const selectedListings = listingOptions.filter((platform) => {
          if (platform === "Facebook") return facebookUrlInput.value.trim();
          if (platform === "TikTok") return tiktokUrlInput.value.trim();
          if (platform === "Ebay") return ebayUrlInput.value.trim();
          if (platform === "Etsy") return etsyUrlInput.value.trim();
          return false;
        });

        const row = {
          category: categoryInput.value,
          product_folder: productFolderInput.value.trim(),
          sku: skuInput.value.trim(),
          UKCA: currentUkcaStatus,
          Listings: selectedListings.join(", "),
          tags: tagsInput.value.trim(),
          "Facebook URL": facebookUrlInput.value.trim(),
          "TikTok URL": tiktokUrlInput.value.trim(),
          "Ebay URL": ebayUrlInput.value.trim(),
          "Etsy URL": etsyUrlInput.value.trim(),
        };

        const response = await fetch("/api/update_row", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            old_category: originalCategory,
            old_product_folder: originalFolder,
            row,
          }),
        });
        const payload = await response.json();
        if (!response.ok) {
          statusEl.textContent = payload.error || "Save failed.";
          return;
        }
        statusEl.textContent = "Details saved.";
        originalCategory = row.category;
        originalFolder = row.product_folder;
        const statusQuery = statusParam ? `&status=${encodeURIComponent(statusParam)}` : "";
        history.replaceState(
          {},
          "",
          `/product.html?category=${encodeURIComponent(row.category)}&folder=${encodeURIComponent(row.product_folder)}${statusQuery}`
        );
      };

      const renameFolder = async () => {
        const newName = productFolderInput.value.trim();
        if (!newName || newName === originalFolder) return;
        const response = await fetch("/api/rename", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: originalCategory,
            old_name: originalFolder,
            new_name: newName,
            status: statusParam,
          }),
        });
        const payload = await response.json();
        if (!response.ok) {
          statusEl.textContent = payload.error || "Rename failed.";
          return;
        }
        statusEl.textContent = "Folder renamed.";
        originalFolder = newName;
        await saveDetails();
        await loadMedia();
        await load3mf();
      };

      const openFolder = () => {
        const basePath = statusParam === "draft" ? draftBasePath : baseCategoriesPath;
        const rawPath = `${basePath}/${categoryParam}/${productFolderInput.value}`;
        const url = encodeURI(`file://${rawPath}`);
        const popup = window.open(url, "_blank");
        if (!popup) {
          navigator.clipboard?.writeText(rawPath).catch(() => {});
          alert("Popup blocked. Path copied to clipboard.");
        }
      };

      const saveReadme = async () => {
        const response = await fetch("/api/readme", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: categoryParam,
            folder_name: productFolderInput.value,
            status: statusParam,
            action: "write",
            content: readmeArea.value,
          }),
        });
        const payload = await response.json();
        if (!response.ok) {
          statusEl.textContent = payload.error || "Save README failed.";
          return;
        }
        statusEl.textContent = "README saved.";
      };

      const openUkcaDialog = () => {
        ukcaProductName.value = productFolderInput.value || "";
        ukcaSku.value = skuInput.value || "";
        if (!ukcaIntendedAge.value) ukcaIntendedAge.value = "3+";
        if (!ukcaManufacturer.value) ukcaManufacturer.value = "GeekyThingsUK";
        if (!ukcaAddress.value) ukcaAddress.value = "United Kingdom";
        if (!ukcaTester.value) ukcaTester.value = "Dan Robinson";
        ukcaDialog.showModal();
      };

      const submitUkcaPack = async (event) => {
        event.preventDefault();
        const payload = {
          category: categoryParam,
          folder_name: productFolderInput.value,
          status: statusParam,
          product_name: ukcaProductName.value.trim(),
          sku: ukcaSku.value.trim(),
          materials: ukcaMaterials.value.trim(),
          intended_age: ukcaIntendedAge.value.trim(),
          manufacturer: ukcaManufacturer.value.trim(),
          address: ukcaAddress.value.trim(),
          tester: ukcaTester.value.trim(),
          test_date: ukcaTestDate.value.trim(),
          notes: ukcaNotes.value.trim(),
        };
        const response = await fetch("/api/ukca_create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const result = await response.json();
        if (!response.ok) {
          statusEl.textContent = result.error || "UKCA pack creation failed.";
          return;
        }
        statusEl.textContent = "UKCA pack created.";
        currentUkcaStatus = "Yes";
        if (rows[rowIndex]) {
          rows[rowIndex].UKCA = "Yes";
        }
        updateUkcaDisplay();
        await openUkcaSection(true);
        ukcaDialog.close();
      };

      const saveUkcaFile = async (fileKey, content) => {
        const response = await fetch("/api/ukca_pack", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: categoryParam,
            folder_name: productFolderInput.value,
            status: statusParam,
            action: "write",
            file: fileKey,
            content,
          }),
        });
        const payload = await response.json();
        if (!response.ok) {
          statusEl.textContent = payload.error || "Failed to save UKCA file.";
          return;
        }
        statusEl.textContent = "UKCA file saved.";
      };

      saveDetailsBtn.addEventListener("click", () => saveDetails().catch(console.error));
      renameBtn.addEventListener("click", () => renameFolder().catch(console.error));
      openFolderBtn.addEventListener("click", openFolder);
      saveReadmeBtn.addEventListener("click", () => saveReadme().catch(console.error));
      ukcaAddBtn.addEventListener("click", () => {
        if (currentUkcaStatus === "Yes") {
          openUkcaSection().catch(console.error);
          return;
        }
        openUkcaDialog();
      });
      ukcaForm.addEventListener("submit", submitUkcaPack);
      ukcaPackDetails.addEventListener("toggle", () => {
        if (ukcaPackDetails.open) {
          loadUkcaPackList().catch(console.error);
        }
      });
      printUkcaBtn.addEventListener("click", () => {
        printUkcaPack().catch(console.error);
      });

      const printUkcaPack = async () => {
        const response = await fetch(
          `/api/ukca_pack?category=${encodeURIComponent(categoryParam)}&folder=${encodeURIComponent(productFolderInput.value)}&status=${encodeURIComponent(statusParam)}`
        );
        if (!response.ok) return;
        const payload = await response.json();
        const files = (payload.files || [])
          .filter((file) => file.exists)
          .filter((file) => file.key !== "readme");
        if (!files.length) {
          statusEl.textContent = "No UKCA files to print.";
          return;
        }
        const sections = [];
        for (const file of files) {
          const fileResponse = await fetch("/api/ukca_pack", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              category: categoryParam,
              folder_name: productFolderInput.value,
              status: statusParam,
              action: "read",
              file: file.key,
            }),
          });
          const filePayload = await fileResponse.json();
          if (!fileResponse.ok) continue;
          sections.push({
            title: ukcaFileLabels[file.key] || file.key,
            content: filePayload.content || "",
          });
        }
        const printWindow = window.open("", "_blank");
        if (!printWindow) {
          alert("Popup blocked. Allow popups to print.");
          return;
        }
        const styles = `
          body { font-family: Arial, sans-serif; padding: 24px; color: #0f172a; }
          h1 { font-size: 20px; margin-bottom: 6px; }
          h2 { margin-top: 24px; font-size: 16px; }
          pre { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; background: #f8fafc; padding: 12px; border-radius: 8px; }
        `;
        const html = `
          <html>
            <head><title>UKCA Pack</title><style>${styles}</style></head>
            <body>
              <h1>UKCA Pack - ${productFolderInput.value}</h1>
              ${sections.map((section) => `<h2>${section.title}</h2><pre>${section.content}</pre>`).join("")}
            </body>
          </html>
        `;
        printWindow.document.open();
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
      };

      const deleteFile = async (relPath) => {
        const response = await fetch("/api/delete_file", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: categoryParam,
            folder_name: productFolderInput.value,
            status: statusParam,
            rel_path: relPath,
          }),
        });
        const payload = await response.json();
        if (!response.ok) {
          statusEl.textContent = payload.error || "Delete failed.";
          return;
        }
        statusEl.textContent = "File moved to _Deleted.";
        await loadMedia();
        await load3mf();
      };

      const uploadFiles = async (files) => {
        if (!files || !files.length) return;
        const formData = new FormData();
        formData.append("category", categoryParam);
        formData.append("folder_name", productFolderInput.value);
        formData.append("status", statusParam);
        formData.append("sku", skuInput.value.trim());
        Array.from(files).forEach((file) => formData.append("files", file));
        statusEl.textContent = "Uploading files...";
        try {
          const response = await fetch("/api/upload", {
            method: "POST",
            body: formData,
          });
          const payload = await response.json();
          if (!response.ok) {
            statusEl.textContent = payload.error || "Upload failed.";
            return;
          }
          statusEl.textContent = `Uploaded ${payload.saved?.length || 0} file(s).`;
          await loadMedia();
          await load3mf();
        } catch (error) {
          console.error(error);
          statusEl.textContent = "Upload failed.";
        }
      };

      uploadZone.addEventListener("click", () => uploadInput.click());
      uploadInput.addEventListener("change", (event) => {
        uploadFiles(event.target.files).catch(console.error);
        uploadInput.value = "";
      });
      uploadZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        uploadZone.classList.add("dragover");
      });
      uploadZone.addEventListener("dragleave", () => {
        uploadZone.classList.remove("dragover");
      });
      uploadZone.addEventListener("drop", (event) => {
        event.preventDefault();
        uploadZone.classList.remove("dragover");
        uploadFiles(event.dataTransfer.files).catch(console.error);
      });

      if (!categoryParam || !folderParam) {
        statusEl.textContent = "Missing product details in URL.";
      } else {
        loadData().catch(console.error);
      }
    </script>
  </body>
</html>
